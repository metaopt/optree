name: Tests with PyDebug

on:
  push:
    branches:
      - main
  pull_request:
    paths:
      - setup.py
      - setup.cfg
      - pyproject.toml
      - MANIFEST.in
      - CMakeLists.txt
      - include/**
      - src/**
      - tests/**
      - optree/**
      - .github/workflows/tests-with-pydebug.yml
  # Allow to trigger the workflow manually
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
  OPTREE_CXX_WERROR: "ON"
  PYTHON: "python"  # to be updated
  PYTHON_TAG: "py3"  # to be updated
  PYTHON_VERSION: "3"  # to be updated
  PYENV_ROOT: "~/.pyenv"  # to be updated
  COLUMNS: "128"

jobs:
  test:
    name: Test for CPython ${{ matrix.python-version }}${{ matrix.python-abiflags }} on ${{ matrix.runner }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        runner: [ubuntu-latest, windows-latest, macos-latest]
        python-version:
          - "3.7"
          - "3.8"
          - "3.9"
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"
        python-abiflags: ["d", "td"]
        exclude:
          - python-version: "3.7"
            python-abiflags: "td"
          - python-version: "3.8"
            python-abiflags: "td"
          - python-version: "3.9"
            python-abiflags: "td"
          - python-version: "3.10"
            python-abiflags: "td"
          - python-version: "3.11"
            python-abiflags: "td"
          - python-version: "3.12"
            python-abiflags: "td"
          - runner: windows-latest  # pyenv-win does not support Python 3.13t yet
            python-version: "3.13"
            python-abiflags: "td"
      fail-fast: false
    timeout-minutes: 120
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up pyenv
        id: setup-pyenv-unix
        if: runner.os != 'Windows'
        run: |
          export PYENV_ROOT="${HOME}/.pyenv"
          export PATH="${PYENV_ROOT}/bin:${PYENV_ROOT}/shims:${PATH}"
          export PATH="${PWD}/venv/bin:${PATH}"
          git clone https://github.com/pyenv/pyenv.git "${PYENV_ROOT}"
          echo "PYENV_ROOT=${PYENV_ROOT}" >> "${GITHUB_ENV}"
          echo "PATH=${PATH}" >> "${GITHUB_ENV}"

      - name: Set up pyenv
        id: setup-pyenv-windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $Env:PYENV_ROOT = "$Env:USERPROFILE\.pyenv"
          $Env:PATH = "$Env:PYENV_ROOT\pyenv-win\bin;$Env:PYENV_ROOT\pyenv-win\shims;$Env:PATH"
          $Env:PATH = "$(Get-Location)\venv\Scripts;$Env:PATH"
          git clone https://github.com/pyenv-win/pyenv-win.git "$Env:PYENV_ROOT"
          Write-Output "PYENV_ROOT=$Env:PYENV_ROOT" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append
          Write-Output "PATH=$Env:PATH" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append

      - name: Determine Python version
        shell: bash
        run: |
          if [[ "${{ runner.os }}" == 'Windows' ]]; then
            pyenv update
          fi
          echo "::group::pyenv install --list"
          pyenv install --list
          echo "::endgroup::"

          if [[ "${{ matrix.python-abiflags }}" == *t* ]]; then
            PYTHON_VERSION="$(
              pyenv install --list | tr -d ' ' | grep -E "^${{ matrix.python-version }}" |
                grep -vF '-' | grep -E '[0-9]t$' | sort -rV | head -n 1
            )"
          elif ! PYTHON_VERSION="$(pyenv latest --known "${{ matrix.python-version }}")"; then
            PYTHON_VERSION="$(
              pyenv install --list | tr -d ' ' | grep -E "^${{ matrix.python-version }}" |
                grep -vF '-' | grep -E '[0-9]$' | sort -rV | head -n 1
            )"
          fi
          echo "PYTHON_VERSION=${PYTHON_VERSION}" | tee -a "${GITHUB_ENV}"

      - uses: actions/cache@v4
        id: python-cache
        with:
          path: ${{ env.PYENV_ROOT }}
          key: ${{ runner.os }}-${{ matrix.python-version }}${{ matrix.python-abiflags }}-${{ env.PYTHON_VERSION }}

      - name: Set up Python
        if: steps.python-cache.outputs.cache-hit != 'true'
        shell: bash
        run: |
          PYENV_INSTALL_ARGS=()
          if [[ "${{ runner.os }}" != 'Windows' ]]; then
            if [[ "${{ matrix.python-abiflags }}" == *d* ]]; then
              PYENV_INSTALL_ARGS+=("--debug")
            fi
          else
            pyenv update
            if [[ "${{ matrix.python-abiflags }}" == *d* ]]; then
              PYENV_INSTALL_ARGS+=("--dev")
            fi
          fi
          pyenv install ${{ env.PYTHON_VERSION }} "${PYENV_INSTALL_ARGS[@]}"

          set -x
          pyenv versions
          pyenv global "$(pyenv versions | grep -F '${{ env.PYTHON_VERSION }}' | tr -d ' ')"
          pyenv rehash

      - name: Set up Environment
        shell: bash
        run: |
          ${{ env.PYTHON }} --version
          ${{ env.PYTHON }} -c 'from pprint import pprint; import sysconfig; pprint(sysconfig.get_config_vars())'
          ${{ env.PYTHON }} -m pip install --upgrade pip setuptools wheel

          PYTHON_TAG="$(
            echo 'import sys; print(
              "{0.name[0]}p{1.major}{1.minor}{2}".format(
                sys.implementation,
                sys.version_info,
                getattr(sys, "abiflags", ""),
              ).lower(),
            )' | ${{ env.PYTHON }} -
          )"
          echo "PYTHON_TAG=${PYTHON_TAG}" | tee -a "${GITHUB_ENV}"

      - name: Install OpTree
        run: |
          ${{ env.PYTHON }} -m pip install -vv --editable '.[test]'

      - name: Test with pytest
        shell: bash
        run: |
          PYTESTOPTS=(
            "--exitfirst"
            "--cov-report=xml:coverage-${{ env.PYTHON_TAG }}.xml"
            "--junit-xml=junit-${{ env.PYTHON_TAG }}.xml"
          )
          make test PYTESTOPTS="${PYTESTOPTS[*]}"

      - name: List generated files
        if: ${{ !cancelled() }}
        shell: bash
        run: |
          find . -type f -name '*.py[co]' -delete
          find . -depth -type d -name "__pycache__" -exec rm -r "{}" +
          if [[ -n "$(git status --ignored --porcelain | grep -vE '/$')" ]]; then
            ls -alh $(git status --ignored --porcelain | grep -vE '/$' | cut -d ' ' -f2)
          fi

      - name: Upload JUnit results to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/test-results-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: tests/junit-${{ env.PYTHON_TAG }}.xml
          flags: junit-${{ env.PYTHON_TAG }}
          name: junit-umbrella
          verbose: true
          fail_ci_if_error: false
