# Contributing to OpTree

Before contributing to OpTree, please follow the instructions below to setup.

1. Fork OpTree ([fork](https://github.com/metaopt/optree/fork)) on GitHub and clone the repository.

    ```bash
    git clone git@github.com:<your username>/optree.git  # use the SSH protocol
    cd optree

    git remote add upstream git@github.com:metaopt/optree.git
    ```

2. Setup a development environment via [`conda`](https://github.com/conda/conda):

    ```bash
    conda env create --file conda-recipe.yaml

    conda activate optree
    ```

3. Setup the [`pre-commit`](https://pre-commit.com) hooks:

    ```bash
    pre-commit install --install-hooks
    ```

Then you are ready to rock. Thanks for contributing to OpTree!

## Install Develop Version

To install OpTree in an "editable" mode, run:

```bash
make install-editable  # or run `pip3 install --no-build-isolation --editable .`
```

in the main directory. This installation is removable by:

```bash
make uninstall
```

## Lint Check

We use several tools to secure code quality, including:

- PEP8 code style: `black`, `isort`, `pylint`, `flake8`
- Type hint check: `mypy`
- C++ Google-style: `cpplint`, `clang-format`
- License: `addlicense`
- Documentation: `pydocstyle`, `doc8`

To make things easier, we create several shortcuts as follows.

To automatically format the code, run:

```bash
make format
```

To check if everything conforms to the specification, run:

```bash
make lint
```

## Test Locally

This command will run automatic tests in the main directory:

```bash
make test
```

## Build Wheels

To build compatible **manylinux2014** ([PEP 599](https://peps.python.org/pep-0599)) wheels for distribution, you can use [`cibuildwheel`](https://github.com/pypa/cibuildwheel).
You will need to install [`docker`](https://www.docker.com) first.
Then run the following command:

```bash
pip3 install --upgrade cibuildwheel

python3 -m cibuildwheel --platform=linux --output-dir=wheelhouse --config-file=pyproject.toml
```

It will build wheel binaries for all supported CPython versions. The outputs will be placed in the `wheelhouse` directory.

To build a wheel for a specific CPython version, you can use the [`CIBW_BUILD`](https://cibuildwheel.readthedocs.io/en/stable/options/#build-skip) environment variable.
For example, the following command will build a wheel for Python 3.7:

```bash
CIBW_BUILD="cp37*manylinux*" python3 -m cibuildwheel --platform=linux --output-dir=wheelhouse --config-file=pyproject.toml
```

You can change `cp37*` to `cp310*` to build for Python 3.10. See <https://cibuildwheel.readthedocs.io/en/stable/options> for more options.

## Documentation

Documentations are written under the [`docs/source`](https://github.com/metaopt/optree/tree/HEAD/docs/source) directory as ReStructuredText (`.rst`) files.
`index.rst` is the main page.
A Tutorial on ReStructuredText can be found [here](https://pythonhosted.org/an_example_pypi_project/sphinx.html).

API References are automatically generated by [Sphinx](http://www.sphinx-doc.org/en/stable) and should be modified when any code changes.

To compile documentation into webpage, run

```bash
make docs
```

The generated webpage locates under directory `docs/build` and will open the browser after building documentation.

Detailed documentation is hosted online at <https://optree.readthedocs.io>.
